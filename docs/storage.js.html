<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: service/storage.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: service/storage.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

fruskac.Storage = (function () {
    /**
     * @global
     * @param {Array} Initial data array
     * @constructor
     */
    function Storage(data) {
        if (!data) {
            data = [];
        }
        this.data = data;
    }

    /**
     * @global
     */
    Storage.prototype = {

        /**
         * Add object to storage
         * @param {Object} value
         * @param {Array|string} selector
         * @param {string} type
         * @param {boolean} visible
         * @returns {*}
         */
        add: function (value, selector, type, visible) {

            var self = this;

            selector = parseSelector(selector);

            var container;

            if (selector) {
                var object = self.get(selector);
                if (object) {
                    if (!object.children) {
                        object.children = [];
                    }
                    container = object.children;
                }
            } else {
                container = self.data;
            }

            if (type) {
                object.type = type;
                return map.add(value, type, visible).then(function (object) {
                    container.push(object);
                });
            } else {
                return new Promise(function (resolve) {
                    container.push(value);
                    resolve(value);
                })
            }

        },

        /**
         * Gets root data array
         * @returns {*}
         */
        root: function () {
            return this.data;
        },

        /**
         * Gets object based on selector and container
         * @param {Array|string} selector
         * @param {Array} container
         * @returns {*}
         */
        get: function (selector, container) {

            selector = parseSelector(selector);

            if (!container) {
                container = this.data;
            }

            if (!selector) {
                return;
            }

            if (selector.indexOf(':') !== -1) {
                var selectorParts = selector.split(':');
                var container = _.find(container, {id: selectorParts[0]}).children;
                selectorParts = selectorParts.splice(1);
                return this.get(selectorParts.join(':'), container);
            }

            return _.find(container, {id: selector});

        },

        /**
         * Gets children based on selector and container
         * @param {Array|string} selector
         * @param {Array} container
         * @returns {*|Array|HTMLElement[]}
         */
        query: function (selector, container) {

            selector = parseSelector(selector);

            if (!container) {
                container = this.data;
            }

            var object = this.get(selector, container);

            return object.children;

        },

        /**
         * Set state (on/off)
         * @param {Array|string} selector
         * @param {boolean} value
         */
        setState: function (selector, value) {

            selector = parseSelector(selector);

            var object = this.get(selector);

            if (object) {
                object.on = value;
                this.setVisible(selector, value);
            }

        },

        /**
         * Get state
         * @param {Array|string} selector
         * @returns {*}
         */
        getState: function (selector) {

            selector = parseSelector(selector);

            var object = this.get(selector);

            if (object) {
                return object.on;
            }

        },

        /**
         * Set visibility
         * @param {Array|string} selector
         * @param {boolean} value
         */
        setVisible: function (selector, value) {

            selector = parseSelector(selector);

            var self = this;

            var object = this.get(selector);

            if (object) {
                object.visible = value;

                if (object.children) {
                    object.children.forEach(function (child) {
                        if (child.id) {
                            self.setVisible([selector, child.id], value)
                        } else {
                            var v = value ? object.on : false;
                            map.setVisible(child, v);
                        }
                    })
                }
            }

        },


        /**
         * Get visibility
         * @param {Array|string} selector
         * @returns {boolean}
         */
        getVisible: function (selector) {

            selector = parseSelector(selector);

            var object = this.get(selector);

            var visible = true;

            if (object) {
                visible = object.visible;

                if (hasParentSelector(selector)) {
                    var parentSelector = getParentSelector(selector);
                    var parentVisible = this.getVisible(parentSelector);
                    if (parentVisible) {
                        if (hasParentSelector(parentSelector)) {
                            return this.getVisible(getParentSelector(parentSelector))
                        }
                    } else {
                        return false;
                    }
                }

            }

            return visible;

        },

        /**
         * Select object based on selector
         * @param {Array|string} selector
         */
        select: function (selector) {

            var self = this;

            selector = parseSelector(selector);

            var object = self.get(selector);

            if (hasParentSelector(selector)) {

                var parent = self.get(getParentSelector(selector));

                self.setState(parent.id, true);

                parent.children.forEach(function (child) {
                    self.setState([parent.id, child.id], child.id === object.id);
                });

            }

            map.focus(object.children[0])

        },

        getSelectors: function () {
            return getSelectorsForContainer(storage.root());
        }
    };

    /**
     * Get parent selector
     * @param {Array|string} selector
     * @returns {string}
     */
    function getParentSelector(selector) {

        selector = parseSelector(selector);

        if (!hasParentSelector(selector)) {
            return;
        }

        var selectorParts = selector.split(':');
        selectorParts.splice(-1);

        return selectorParts.join(':');
    }

    /**
     * Test if parent selector is available
     * @param {Array|string} selector
     * @returns {boolean}
     */
    function hasParentSelector(selector) {

        selector = parseSelector(selector);

        return selector.indexOf(':') !== -1;
    }

    /**
     * Parse array (if provided) into string
     * @param {Array|string} selector
     * @returns {*}
     */
    function parseSelector(selector) {
        if (_.isArray(selector)) {
            selector = selector.join(':');
        }

        return selector;

    }

    /**
     *
     * @param {Array} items
     * @param {Array|string} selector
     * @returns {Array}
     */
    function getSelectorsForContainer(items, selector) {

        selector = parseSelector(selector);

        var children = [];

        items.forEach(function (item) {

            if (!item.id) {
                return;
            }

            var itemSelector;
            if (selector) {
                itemSelector = parseSelector([selector, item.id]);
            } else {
                itemSelector = item.id
            }

            var object = {
                id: item.id,
                getVisible: function () {
                    return storage.getState(itemSelector);
                },
                setVisible: function (value) {
                    return storage.setState(itemSelector, value);
                },
                select: function () {
                    return storage.select(itemSelector);
                }
            };

            if (item.type) {
                object.type = item.type;
            }

            if (item.children &amp;&amp; item.children.length) {
                var subChildren = getSelectorsForContainer(item.children, itemSelector);
                if (subChildren &amp;&amp; subChildren.length) {
                    object.children = subChildren;
                }
            }

            children.push(object)

        });

        return children;

    }


    return Storage;

})();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Chart.html">Chart</a></li><li><a href="Kml.html">Kml</a></li><li><a href="Map.html">Map</a></li><li><a href="Marker.html">Marker</a></li><li><a href="Storage.html">Storage</a></li><li><a href="Track.html">Track</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Mon Feb 27 2017 20:06:17 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
