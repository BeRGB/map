"use strict";function api(){}!function(e){function t(){}t.prototype=t,e.fruskac=t}(window),fruskac.Util=function(){function e(){}return e.prototype={getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),a=n.exec(t);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null},getParameterPartsByName:function(e){var t=this.getParameterByName(e);if(t)return t.split(",")}},e}(),fruskac.TYPE={MARKER:"marker",TRACK:"track",KML:"kml"},function(e){e.maps.Polyline.prototype.getBounds=function(){var t=new e.maps.LatLngBounds;return this.getPath().forEach(function(n){t.extend(new e.maps.LatLng(n.lat(),n.lng()))}),t}}(google),fruskac.Marker=function(){function e(e){e=_.extend({map:gmap},e);var n;if("string"==typeof e.icon){switch(e.icon){case"lakes":n="mm_20_purple";break;case"monasteries":n="mm_20_yellow";break;case"misc":n="mm_20_blue";break;case"springs":n="mm_20_white";break;case"picnic-areas":n="mm_20_green";break;case"monuments":n="mm_20_red";break;case"fishponds":n="mm_20_black";break;case"waterfalls":n="mm_20_orange";break;case"lookouts":n="mm_20_gray";break;case"meadows":n="mm_20_brown";break;default:n="mm_20_white"}e.icon="//maps.gstatic.com/mapfiles/ridefinder-images/"+n+".png"}else e.icon&&e.icon.hasOwnProperty("url")?e.icon=new google.maps.MarkerImage(e.icon.url,new google.maps.Size(e.icon.width,e.icon.height),new google.maps.Point(e.icon.x,e.icon.y)):e.icon="//maps.gstatic.com/mapfiles/ridefinder-images/mm_20_white.png";return function(){var n=new google.maps.Marker(e);return google.maps.event.addListener(n,"click",function(){map.showInfoWindow(t(e.data),this)}),n}()}function t(e){var t="<h1>"+e.title+"</h1>";return e.description&&(t+="<p>"+e.description+"</p>"),e.image&&(t+='<img src="'+e.image+'">'),e.link&&(t+='<a href="'+e.link+'" target="_blank">'+e.link+"</a>"),t}return e}(),fruskac.Track=function(){function e(e){return e=_.extend({map:gmap,geodesic:!0,strokeColor:"rgb(51, 102, 204)",strokeOpacity:1,strokeWeight:4},e),function(){return new google.maps.Polyline(e)}()}return e}(),fruskac.Kml=function(){function e(e,t){return t=_.extend({map:gmap,preserveViewport:!0,suppressInfoWindows:!0,data:{type:"kml"}},t),function(){return new google.maps.KmlLayer(e,t)}()}return e}(),fruskac.Chart=function(){function e(e){var t=this;t.visible=!1,t.container=e,$(t.container).append('<button onclick="chart.setVisible(false)">X</button>').append('<div id="chart_content"><div class="loading">Loading...</div></div>')}function t(e,t,a){var r=[];e.forEach(function(e){r.push(e)}),t.getElevationAlongPath({path:r,samples:r.length},function(e){var t=0,r=[];e.forEach(function(a,o){var i;i=o?n(e[o].location,e[o-1].location):0,t+=parseFloat(i),r.push([t,a.elevation])}),a(r)})}function n(e,t){var n=6378137,r=a(t.lat()-e.lat()),o=a(t.lng()-e.lng()),i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(a(e.lat()))*Math.cos(a(t.lat()))*Math.sin(o/2)*Math.sin(o/2),s=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),c=n*s;return(c/1e3).toFixed(2)}function a(e){return e*Math.PI/180}return e.prototype={setVisible:function(e){var t=this;t.visible=e;var n="on";t.visible?$(t.container).addClass(n):$(t.container).removeClass(n);var a=gmap.getCenter();google.maps.event.trigger(gmap,"resize"),gmap.setCenter(a)},show:function(e,n){var a=this;a.setVisible(!0),n&&$(a.container).find("button").remove();var r=new google.maps.ElevationService;google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(function(){t(e,r,function(t){var n=new google.visualization.DataTable;n.addColumn("number","Distance"),n.addColumn("number","Elevation"),n.addRows(t);var a={lineWidth:5,focusTarget:"category",hAxis:{title:"Distance (km)"},vAxis:{title:"Elevation (m)",minValue:0},legend:{position:"none"}},r=new google.visualization.AreaChart(document.getElementById("chart_content"));r.draw(n,a),google.visualization.events.addListener(r,"onmouseover",function(t){map.placeMarker(e.getAt(t.row))}),$(window).on("resize",function(){r.draw(n,a)})})})}},e}(),fruskac.Map=function(){function e(e){this.infoWindow=new google.maps.InfoWindow({content:"holding..."})}function t(e){if(e)return e.hasOwnProperty("position")?fruskac.TYPE.MARKER:e.hasOwnProperty("strokeColor")?fruskac.TYPE.TRACK:e.hasOwnProperty("suppressInfoWindows")?fruskac.TYPE.KML:void 0}return e.prototype={add:function(e,t,n){var a=this;return new Promise(function(r){switch(t){case fruskac.TYPE.MARKER:return a.addMarker(e,n).then(function(e){r(e)});case fruskac.TYPE.TRACK:return a.addTrack(e,n).then(function(e){r(e)});case fruskac.TYPE.KML:return a.addKml(e,n).then(function(e){r(e)})}})},addMarker:function(e,t){return new Promise(function(n){var a=new fruskac.Marker({position:new google.maps.LatLng(e.lat,e.lng),title:e.data.title,icon:e.options.icon_data,data:e.data});a.setVisible(t),clusterer.addMarker(a),n(a)})},addTrack:function(e,t){return new Promise(function(n){return $.get("../"+e.url).then(function(e){var a=[];$(e).find("trkpt").each(function(e,t){var n=Number($(this).attr("lat")),r=Number($(this).attr("lon")),o=new google.maps.LatLng(n,r);a.push(o)});var r=new fruskac.Track({path:a});r.setVisible(t),n(r)})})},addKml:function(e,t){return new Promise(function(n){var a=new fruskac.Kml(e.url);t||a.setMap(null),n(a)})},setVisible:function(e,n){switch(t(e)){case fruskac.TYPE.MARKER:e.setVisible(n),n?clusterer.addMarker(e):clusterer.removeMarker(e);break;case fruskac.TYPE.TRACK:e.setVisible(n);break;case fruskac.TYPE.KML:e.setMap(n?gmap:null)}},focus:function(e,n){switch(t(e)){case fruskac.TYPE.MARKER:gmap.setZoom(14),gmap.panTo(e.position),e.setAnimation(google.maps.Animation.BOUNCE);break;case fruskac.TYPE.TRACK:gmap.fitBounds(e.getBounds()),chart.show(e.getPath(),n)}},placeMarker:function(e){var t=this;t.marker?t.marker.animateTo(e,{duration:50}):t.marker=new fruskac.Marker({position:e})},showInfoWindow:function(e,t){var n=this;n.infoWindow.setContent(e),n.infoWindow.open(gmap,t)}},e}(),fruskac.Storage=function(){function e(e){e||(e=[]),this.data=e}function t(e){if(e=a(e),n(e)){var t=e.split(":");return t.splice(-1),t.join(":")}}function n(e){return e=a(e),e.indexOf(":")!==-1}function a(e){return _.isArray(e)&&(e=e.join(":")),e}function r(e,t){t=a(t);var n=[];return e.forEach(function(e){if(e.id){var o;o=t?a([t,e.id]):e.id;var i={id:e.id,getVisible:function(){return storage.getState(o)},setVisible:function(e){return storage.setState(o,e)},select:function(){return storage.focus(o)}};if(e.type&&(i.type=e.type),e.children&&e.children.length){var s=r(e.children,o);s&&s.length&&(i.children=s)}n.push(i)}}),n}return e.prototype={add:function(e,t,n,r){var o=this;t=a(t);var i;if(t){var s=o.get(t);s&&(s.children||(s.children=[]),i=s.children)}else i=o.data;return n?(s.type=n,map.add(e,n,r).then(function(e){i.push(e)})):new Promise(function(t){i.push(e),t(e)})},root:function(){return this.data},get:function(e,t){if(e=a(e),t||(t=this.data),e){if(e.indexOf(":")!==-1){var n=e.split(":"),t=_.find(t,{id:n[0]}).children;return n=n.splice(1),this.get(n.join(":"),t)}return _.find(t,function(t){if(t&&t.id===e||t.hasOwnProperty("data")&&t.data.id==e)return t})}},query:function(e,t){e=a(e),t||(t=this.data);var n=this.get(e,t);return n.children},setState:function(e,t){e=a(e);var n=this.get(e);n&&(n.on=t,this.setVisible(e,t))},getState:function(e){e=a(e);var t=this.get(e);if(t)return t.on},setVisible:function(e,t){e=a(e);var n=this,r=this.get(e);r&&(r.visible=t,r.children&&r.children.forEach(function(a){if(a.id)n.setVisible([e,a.id],t);else{var o=!!t&&r.on;map.setVisible(a,o)}}))},getVisible:function(e){e=a(e);var r=this.get(e),o=!0;if(r&&(o=r.visible,n(e))){var i=t(e),s=this.getVisible(i);if(!s)return!1;if(n(i))return this.getVisible(t(i))}return o},focus:function(e,r){var o=this;e=a(e);var i=o.get(e);if(n(e)){var s=o.get(t(e));o.setState(s.id,!0),s.children.forEach(function(e){e.hasOwnProperty("id")&&o.setState([s.id,e.id],e.id===i.id)})}map.focus(i&&i.hasOwnProperty("children")?i.children[0]:i,r)},getSelectors:function(){return r(storage.root())}},e}(),fruskac.Loader=function(){function e(){}function t(e,t,n){return"string"==typeof e&&(e={name:e,url:"../data/"+e+".json"}),storage.add({id:e.name,visible:n,on:n}).then(function(){return $.get(e.url).success(function(a){var r=[];return a.forEach(function(a){var o,i=storage.get([e.name,a.tag]);o=i?new Promise(function(e){e()}):storage.add({id:a.tag,visible:n,on:n,type:t},e.name),o.then(function(){storage.add(a,[e.name,a.tag],t,n)}),r.push(o)}),Promise.all(r)})})}return e.prototype={load:function(e){var n=[];return e.forEach(function(e){n.push(t.apply(this,e))}),Promise.all(n)}},e}();var util=new fruskac.Util,storage=new fruskac.Storage,mapConfig={center:new google.maps.LatLng(45.167031,19.69677),zoom:11,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},latLngZoom=util.getParameterByName("l");if(latLngZoom){var parts=util.getParameterPartsByName("l");parts&&parts.length&&(parts[0]&&parts[1]&&(mapConfig.center=new google.maps.LatLng(parts[0],parts[1])),parts[2]&&(mapConfig.zoom=parseFloat(parts[2])))}var gmap=new google.maps.Map(document.getElementById("map"),mapConfig),overlayImageBounds={north:45.166508,south:45.136001,east:19.767672,west:19.681498},overlayOptions={opacity:.8,clickable:!1},groundOverlay=new google.maps.GroundOverlay("http://fruskac.net/sites/all/themes/fruskac/css/img/fruskac-logo-map.png",overlayImageBounds,overlayOptions);groundOverlay.setMap(gmap);var map=new fruskac.Map(gmap),clusterer=new MarkerClusterer(gmap,[],{maxZoom:13,gridSize:50,imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});clusterer.enabled=!0;var chart=new fruskac.Chart(document.getElementById("chart")),loader=new fruskac.Loader,focus=util.getParameterByName("f");loader.load([["locations",fruskac.TYPE.MARKER,!0],["marathon",fruskac.TYPE.TRACK,!0],["protection",fruskac.TYPE.KML,!0],["time",fruskac.TYPE.MARKER,!0]]).then(function(){focus&&google.maps.event.addListenerOnce(gmap,"idle",function(){storage.focus(focus,!0)})}),api.prototype={ready:function(e){e()},getData:function(){return storage.getSelectors()},clustering:function(e){return void 0===e?clusterer.enabled:(clusterer.enabled=e,e?(clusterer.setMaxZoom(null),clusterer.setGridSize(50)):(clusterer.setMaxZoom(1),clusterer.setGridSize(1)),clusterer.resetViewport(),clusterer.redraw(),void 0)},type:function(e){return void 0===e?gmap.getMapTypeId():gmap.setMapTypeId(e)}};