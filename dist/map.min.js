"use strict";function load(t,e,n){var r="../data/"+t+".json";Storage.add({id:t,visible:n,on:n}).then(function(){$.get(r).success(function(r){r.forEach(function(r){var i,a=Storage.get([t,r.tag]);i=a?new Promise(function(t){t()}):Storage.add({id:r.tag,visible:n,on:n,type:e},t),i.then(function(){Storage.add(r,[t,r.tag],e,n)})})})})}!function(t){var e=function(){};e.prototype=e,t.fruskac=e}(window),function(t){var e={MARKER:"marker",TRACK:"track",KML:"kml"};t.prototype.TYPE=function(){return e}()}(window.fruskac),function(t){t.maps.Polyline.prototype.getBounds=function(){var e=new t.maps.LatLngBounds;return this.getPath().forEach(function(n){e.extend(new t.maps.LatLng(n.lat(),n.lng()))}),e}}(google),function(t,e){function n(t){var e="<h1>"+t.title+"</h1>";return t.description&&(e+="<p>"+t.description+"</p>"),t.image&&(e+='<img src="'+t.image+'">'),t.link&&(e+='<a href="'+t.link+'" target="_blank">'+t.link+"</a>"),e}var r=function(t){t=_.extend({map:Map.getMap()},t);var r;switch(t.icon){case"lakes":r="mm_20_purple";break;case"monasteries":r="mm_20_yellow";break;case"misc":r="mm_20_blue";break;case"springs":r="mm_20_white";break;case"picnic-areas":r="mm_20_green";break;case"monuments":r="mm_20_red";break;case"fishponds":r="mm_20_black";break;case"waterfalls":r="mm_20_orange";break;case"lookouts":r="mm_20_gray";break;case"meadows":r="mm_20_brown";break;default:r="mm_20_white"}return t.icon="http://maps.gstatic.com/mapfiles/ridefinder-images/"+r+".png",function(){var r=new e.maps.Marker(t);return e.maps.event.addListener(r,"click",function(){Map.showInfoWindow(n(t.data),this)}),r}()};t.prototype.Marker=r}(window.fruskac,google),function(t){var e=function(t){return t=_.extend({map:Map.getMap(),geodesic:!0,strokeColor:"rgb(51, 102, 204)",strokeOpacity:1,strokeWeight:4},t),function(){return new google.maps.Polyline(t)}()};t.prototype.Track=e}(fruskac),function(t,e){function n(t,n){return n=_.extend({map:Map.getMap(),preserveViewport:!0,suppressInfoWindows:!0,data:{type:"kml"}},n),function(){return new e.maps.KmlLayer(t,n)}()}t.prototype.Kml=n}(window.fruskac,google),function(t,e,n,r){function i(t,e,n){var r=[];t.forEach(function(t){r.push(t)}),e.getElevationAlongPath({path:r,samples:r.length},function(t){var e=0,r=[];t.forEach(function(n,i){var o;o=i?a(t[i].location,t[i-1].location):0,e+=parseFloat(o),r.push([e,n.elevation])}),n(r)})}function a(t,e){var n=6378137,r=o(e.lat()-t.lat()),i=o(e.lng()-t.lng()),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos(o(t.lat()))*Math.cos(o(e.lat()))*Math.sin(i/2)*Math.sin(i/2),s=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),c=n*s;return(c/1e3).toFixed(2)}function o(t){return t*Math.PI/180}var s=function(t){this.visible=!1,this.container=t,this.map=Map.getMap(),e(this.container).append('<button onclick="ChartService.setVisible(false)">X</button>').append('<div id="chart_content"></div>')};s.prototype={setVisible:function(t){this.visible=t;var r="on";this.visible?e(this.container).addClass(r):e(this.container).removeClass(r);var i=this.map.getCenter();n.maps.event.trigger(this.map,"resize"),this.map.setCenter(i)},show:function(t){this.setVisible(!0);var e=new n.maps.ElevationService;n.charts.load("current",{packages:["corechart"]}),n.charts.setOnLoadCallback(function(){i(t,e,function(e){var r=new n.visualization.DataTable;r.addColumn("number","Distance"),r.addColumn("number","Elevation"),r.addRows(e);var i={lineWidth:5,focusTarget:"category",hAxis:{title:"Distance (km)"},vAxis:{title:"Elevation (m)",minValue:0},legend:{position:"none"}},a=new n.visualization.AreaChart(document.getElementById("chart_content"));a.draw(r,i),n.visualization.events.addListener(a,"onmouseover",function(e){Map.placeMarker(t.getAt(e.row))})})})}},r.prototype.ChartService=s}(window,jQuery,google,window.fruskac),function(t,e){var n=function(t){this.map=t,this.infoWindow=new google.maps.InfoWindow({content:"holding..."})};n.prototype={add:function(t,n,r){var i=this;return new Promise(function(a){switch(n){case e.TYPE.MARKER:return i.addMarker(t,r).then(function(t){a(t)});case e.TYPE.TRACK:return i.addTrack(t,r).then(function(t){a(t)});case e.TYPE.KML:return i.addKml(t,r).then(function(t){a(t)})}})},addMarker:function(t,n){return new Promise(function(r){var i=new e.Marker({position:new google.maps.LatLng(t.lat,t.lng),title:t.data.title,icon:t.tag,data:t.data});i.setVisible(n),Clusterer.addMarker(i),r(i)})},addTrack:function(t,n){return new Promise(function(r){return $.get("../"+t.url).then(function(t){var i=[];$(t).find("trkpt").each(function(t,e){var n=Number($(this).attr("lat")),r=Number($(this).attr("lon")),a=new google.maps.LatLng(n,r);i.push(a)});var a=new e.Track({path:i});a.setVisible(n),r(a)})})},addKml:function(t,n){return new Promise(function(r){var i=new e.Kml(t.url);n||i.setMap(null),r(i)})},setVisible:function(t,e){t.hasOwnProperty("position")?(t.setVisible(e),e?Clusterer.addMarker(t):Clusterer.removeMarker(t)):t.hasOwnProperty("strokeColor")?t.setVisible(e):t.hasOwnProperty("suppressInfoWindows")&&t.setMap(e?this.map:null)},getMap:function(){return this.map},focus:function(t){this.map.fitBounds(t.getBounds()),e.Chart.show(t.getPath())},placeMarker:function(t){this.marker?this.marker.animateTo(t,{duration:50}):this.marker=new e.Marker({position:t})},showInfoWindow:function(t,e){this.infoWindow.setContent(t),this.infoWindow.open(this.map,e)}},e.MapService=n}(window,window.fruskac),function(t,e){function n(t){t||(t=[]),this.data=t}function r(t){if(t=a(t),i(t)){var e=t.split(":");return e.splice(-1),e.join(":")}}function i(t){return t=a(t),t.indexOf(":")!==-1}function a(t){return _.isArray(t)&&(t=t.join(":")),t}function o(t,e){e=a(e);var n=[];return t.forEach(function(t){if(t.id){var r;r=e?a([e,t.id]):t.id;var i={id:t.id,getVisible:function(){return Storage.getState(r)},setVisible:function(t){return Storage.setState(r,t)},select:function(){return Storage.select(r)}};if(t.type&&(i.type=t.type),t.children&&t.children.length){var s=o(t.children,r);s&&s.length&&(i.children=s)}n.push(i)}}),n}n.prototype={add:function(t,e,n,r){var i=this;e=a(e);var o;if(e){var s=i.get(e);s&&(s.children||(s.children=[]),o=s.children)}else o=i.data;return n?(s.type=n,Map.add(t,n,r).then(function(t){o.push(t)})):new Promise(function(e){o.push(t),e(t)})},root:function(){return this.data},get:function(t,e){if(t=a(t),e||(e=this.data),t){if(t.indexOf(":")!==-1){var n=t.split(":"),e=_.find(e,{id:n[0]}).children;return n=n.splice(1),this.get(n.join(":"),e)}return _.find(e,{id:t})}},query:function(t,e){t=a(t),e||(e=this.data);var n=this.get(t,e);return n.children},setState:function(t,e){t=a(t);var n=this.get(t);n&&(n.on=e,this.setVisible(t,e))},getState:function(t){t=a(t);var e=this.get(t);if(e)return e.on},setVisible:function(t,e){t=a(t);var n=this,r=this.get(t);r&&(r.visible=e,r.children&&r.children.forEach(function(i){if(i.id)n.setVisible([t,i.id],e);else{var a=!!e&&r.on;Map.setVisible(i,a)}}))},getVisible:function(t){t=a(t);var e=this.get(t),n=!0;if(e&&(n=e.visible,i(t))){var o=r(t),s=this.getVisible(o);if(!s)return!1;if(i(o))return this.getVisible(r(o))}return n},select:function(t){t=a(t);var e=this.get(t);if(i(t)){var n=Storage.get(r(t));Storage.setState(n.id,!0),n.children.forEach(function(t){Storage.setState([n.id,t.id],t.id===e.id)})}Map.focus(e.children[0])},getSelectors:function(){return o(Storage.root())}},e.StorageService=n}(window,window.fruskac);var Storage=new fruskac.StorageService,Map=new fruskac.MapService(new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(45.167031,19.69677),zoom:10,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}})),Clusterer=new MarkerClusterer(Map.getMap(),[],{gridSize:50,imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});Clusterer.enabled=!0,fruskac.prototype.Chart=new fruskac.ChartService(document.getElementById("chart")),load("locations",fruskac.TYPE.MARKER,!0),load("marathon",fruskac.TYPE.TRACK,!0),load("protection",fruskac.TYPE.KML,!0),load("time",fruskac.TYPE.MARKER,!0),window.FruskacMap={ready:function(t){t()},getData:function(){return Storage.getSelectors()},clustering:function(t){return void 0===t?Clusterer.enabled:(Clusterer.enabled=t,t?(Clusterer.setMaxZoom(null),Clusterer.setGridSize(50)):(Clusterer.setMaxZoom(1),Clusterer.setGridSize(1)),Clusterer.resetViewport(),Clusterer.redraw(),void 0)},type:function(t){return void 0===t?Map.getMap().getMapTypeId():Map.getMap().setMapTypeId(t)}};