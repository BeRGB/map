"use strict";!function(t){var e=function(){};e.prototype=e,t.fruskac=e}(window),function(t){var e={MARKER:"marker",TRACK:"track",KML:"kml"};t.prototype.TYPE=function(){return e}()}(window.fruskac),function(t){t.maps.Polyline.prototype.getBounds=function(){var e=new t.maps.LatLngBounds;return this.getPath().forEach(function(n){e.extend(new t.maps.LatLng(n.lat(),n.lng()))}),e}}(google),function(t,e){function n(t){var e="<h1>"+t.title+"</h1>";return t.description&&(e+="<p>"+t.description+"</p>"),t.image&&(e+='<img src="'+t.image+'">'),t.link&&(e+='<a href="'+t.link+'" target="_blank">'+t.link+"</a>"),e}var i=function(i){i=_.extend({map:t.map.getMap()},i);var a;switch(i.icon){case"lakes":a="mm_20_purple";break;case"monasteries":a="mm_20_yellow";break;case"misc":a="mm_20_blue";break;case"springs":a="mm_20_white";break;case"picnic-areas":a="mm_20_green";break;case"monuments":a="mm_20_red";break;case"fishponds":a="mm_20_black";break;case"waterfalls":a="mm_20_orange";break;case"lookouts":a="mm_20_gray";break;case"meadows":a="mm_20_brown";break;default:a="mm_20_white"}return i.icon="http://maps.gstatic.com/mapfiles/ridefinder-images/"+a+".png",function(){var t=new e.maps.Marker(i);return e.maps.event.addListener(t,"click",function(){Map.showInfoWindow(n(i.data),this)}),t}()};t.prototype.Marker=i}(window.fruskac,google),function(t){var e=function(e){return e=_.extend({map:t.map.getMap(),geodesic:!0,strokeColor:"rgb(51, 102, 204)",strokeOpacity:1,strokeWeight:4},e),function(){return new google.maps.Polyline(e)}()};t.prototype.Track=e}(fruskac),function(t,e){function n(n,i){return i=_.extend({map:t.map.getMap(),preserveViewport:!0,suppressInfoWindows:!0,data:{type:"kml"}},i),function(){return new e.maps.KmlLayer(n,i)}()}t.prototype.Kml=n}(window.fruskac,google),function(t,e,n,i){function a(t,e,n){var i=[];t.forEach(function(t){i.push(t)}),e.getElevationAlongPath({path:i,samples:i.length},function(t){var e=0,i=[];t.forEach(function(n,a){var o;o=a?r(t[a].location,t[a-1].location):0,e+=parseFloat(o),i.push([e,n.elevation])}),n(i)})}function r(t,e){var n=6378137,i=o(e.lat()-t.lat()),a=o(e.lng()-t.lng()),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(o(t.lat()))*Math.cos(o(e.lat()))*Math.sin(a/2)*Math.sin(a/2),s=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),c=n*s;return(c/1e3).toFixed(2)}function o(t){return t*Math.PI/180}var s=function(t){var n=this;n.visible=!1,n.container=t,n.map=i.map.getMap(),e(n.container).append('<button onclick="fruskac.chart.setVisible(false)">X</button>').append('<div id="chart_content"></div>')};s.prototype={setVisible:function(t){var i=this;i.visible=t;var a="on";i.visible?e(i.container).addClass(a):e(i.container).removeClass(a);var r=i.map.getCenter();n.maps.event.trigger(i.map,"resize"),i.map.setCenter(r)},show:function(r){var o=this;o.setVisible(!0);var s=new n.maps.ElevationService;n.charts.load("current",{packages:["corechart"]}),n.charts.setOnLoadCallback(function(){a(r,s,function(a){var o=new n.visualization.DataTable;o.addColumn("number","Distance"),o.addColumn("number","Elevation"),o.addRows(a);var s={lineWidth:5,focusTarget:"category",hAxis:{title:"Distance (km)"},vAxis:{title:"Elevation (m)",minValue:0},legend:{position:"none"}},c=new n.visualization.AreaChart(document.getElementById("chart_content"));c.draw(o,s),n.visualization.events.addListener(c,"onmouseover",function(t){i.map.placeMarker(r.getAt(t.row))}),e(t).on("resize",function(){c.draw(o,s)})})})}},i.prototype.Chart=s}(window,jQuery,google,window.fruskac),function(t,e){var n=function(t){this.map=t,this.infoWindow=new google.maps.InfoWindow({content:"holding..."})};n.prototype={add:function(t,n,i){var a=this;return new Promise(function(r){switch(n){case e.TYPE.MARKER:return a.addMarker(t,i).then(function(t){r(t)});case e.TYPE.TRACK:return a.addTrack(t,i).then(function(t){r(t)});case e.TYPE.KML:return a.addKml(t,i).then(function(t){r(t)})}})},addMarker:function(t,n){return new Promise(function(i){var a=new e.Marker({position:new google.maps.LatLng(t.lat,t.lng),title:t.data.title,icon:t.tag,data:t.data});a.setVisible(n),e.clusterer.addMarker(a),i(a)})},addTrack:function(t,n){return new Promise(function(i){return $.get("../"+t.url).then(function(t){var a=[];$(t).find("trkpt").each(function(t,e){var n=Number($(this).attr("lat")),i=Number($(this).attr("lon")),r=new google.maps.LatLng(n,i);a.push(r)});var r=new e.Track({path:a});r.setVisible(n),i(r)})})},addKml:function(t,n){return new Promise(function(i){var a=new e.Kml(t.url);n||a.setMap(null),i(a)})},setVisible:function(t,n){t.hasOwnProperty("position")?(t.setVisible(n),n?e.clusterer.addMarker(t):e.clusterer.removeMarker(t)):t.hasOwnProperty("strokeColor")?t.setVisible(n):t.hasOwnProperty("suppressInfoWindows")&&t.setMap(n?this.map:null)},getMap:function(){return this.map},focus:function(t){this.map.fitBounds(t.getBounds()),e.chart.show(t.getPath())},placeMarker:function(t){var n=this;n.marker?n.marker.animateTo(t,{duration:50}):n.marker=new e.Marker({position:t})},showInfoWindow:function(t,e){var n=this;n.infoWindow.setContent(t),n.infoWindow.open(n.map,e)}},e.Map=n}(window,window.fruskac),function(t,e){function n(t){t||(t=[]),this.data=t}function i(t){if(t=r(t),a(t)){var e=t.split(":");return e.splice(-1),e.join(":")}}function a(t){return t=r(t),t.indexOf(":")!==-1}function r(t){return _.isArray(t)&&(t=t.join(":")),t}function o(t,n){n=r(n);var i=[];return t.forEach(function(t){if(t.id){var a;a=n?r([n,t.id]):t.id;var s={id:t.id,getVisible:function(){return e.storage.getState(a)},setVisible:function(t){return e.storage.setState(a,t)},select:function(){return e.storage.select(a)}};if(t.type&&(s.type=t.type),t.children&&t.children.length){var c=o(t.children,a);c&&c.length&&(s.children=c)}i.push(s)}}),i}n.prototype={add:function(t,n,i,a){var o=this;n=r(n);var s;if(n){var c=o.get(n);c&&(c.children||(c.children=[]),s=c.children)}else s=o.data;return i?(c.type=i,e.map.add(t,i,a).then(function(t){s.push(t)})):new Promise(function(e){s.push(t),e(t)})},root:function(){return this.data},get:function(t,e){if(t=r(t),e||(e=this.data),t){if(t.indexOf(":")!==-1){var n=t.split(":"),e=_.find(e,{id:n[0]}).children;return n=n.splice(1),this.get(n.join(":"),e)}return _.find(e,{id:t})}},query:function(t,e){t=r(t),e||(e=this.data);var n=this.get(t,e);return n.children},setState:function(t,e){t=r(t);var n=this.get(t);n&&(n.on=e,this.setVisible(t,e))},getState:function(t){t=r(t);var e=this.get(t);if(e)return e.on},setVisible:function(t,n){t=r(t);var i=this,a=this.get(t);a&&(a.visible=n,a.children&&a.children.forEach(function(r){if(r.id)i.setVisible([t,r.id],n);else{var o=!!n&&a.on;e.map.setVisible(r,o)}}))},getVisible:function(t){t=r(t);var e=this.get(t),n=!0;if(e&&(n=e.visible,a(t))){var o=i(t),s=this.getVisible(o);if(!s)return!1;if(a(o))return this.getVisible(i(o))}return n},select:function(t){var n=this;t=r(t);var o=n.get(t);if(a(t)){var s=n.get(i(t));n.setState(s.id,!0),s.children.forEach(function(t){n.setState([s.id,t.id],t.id===o.id)})}e.map.focus(o.children[0])},getSelectors:function(){return o(e.storage.root())}},e.Storage=n}(window,window.fruskac),function(t,e,n){function i(t,e,n){var i="../data/"+t+".json";a.add({id:t,visible:n,on:n}).then(function(){$.get(i).success(function(i){i.forEach(function(i){var r,o=a.get([t,i.tag]);r=o?new Promise(function(t){t()}):a.add({id:i.tag,visible:n,on:n,type:e},t),r.then(function(){a.add(i,[t,i.tag],e,n)})})})})}var a=e.storage=new e.Storage,r=e.map=new e.Map(new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(45.167031,19.69677),zoom:10,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}})),o=e.clusterer=new MarkerClusterer(r.getMap(),[],{gridSize:50,imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});o.enabled=!0,e.chart=new e.Chart(document.getElementById("chart")),i("locations",n.MARKER,!0),i("marathon",n.TRACK,!0),i("protection",n.KML,!0),i("time",n.MARKER,!0),t.FruskacMap={ready:function(t){t()},getData:function(){return a.getSelectors()},clustering:function(t){return void 0===t?o.enabled:(o.enabled=t,t?(o.setMaxZoom(null),o.setGridSize(50)):(o.setMaxZoom(1),o.setGridSize(1)),o.resetViewport(),o.redraw(),void 0)},type:function(t){return void 0===t?r.getMap().getMapTypeId():r.getMap().setMapTypeId(t)}}}(window,window.fruskac,window.fruskac.TYPE);